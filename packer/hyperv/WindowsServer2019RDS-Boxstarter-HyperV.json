{
    "variables": {
        "iso-url": "E:/ISOs/en_windows_10_business_editions_version_1903_x64_dvd_37200948.iso",
        "winrmuser": "packer",
        "elevateduser": "administrator"
    },
    "builders": [
        {
          "type": "hyperv-iso",
          "guest_additions_mode": "disable",
          "iso_url": "{{ user `iso-url` }}",
          "iso_checksum": "{{ user `iso_checksum` }}",
          "iso_checksum_type": "md5",
          "ram_size_mb": 2048,
          "communicator": "winrm",
          "winrm_username": "winrm",
          "winrm_password": "Passw0rd",
          "winrm_timeout": "12h",
          "shutdown_command": "C:/Windows/Panther/Unattend/packer_shutdown.bat",
          "shutdown_timeout": "15m",
          "switch_name": "internal_switch",
          "floppy_files": [
            "answer_files/2016/Autounattend.xml",
            "scripts/winrm.ps1"
          ]
        }
      ],
    "provisioners": [
        {
            "type": "powershell",
            "inline": [
                "Write-Host \"---- Disable Windows Defender real time scan\"",
                "Set-MpPreference -DisableRealtimeMonitoring $true",
                "Write-Host \"---- Setup deployment environment\"",
                "Set-ExecutionPolicy Bypass -Scope Process -Force",
                "[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12",
                "Invoke-Expression ((New-Object System.Net.WebClient).DownloadString('https://raw.githubusercontent.com/aaronparker/build-azure/master/rds-packer/Setup-Environment.ps1'))"
            ]
        },
        {
            "type": "powershell",
            "inline": [
                "Import-Module Boxstarter.Chocolatey",
                "Write-Host \"---- Configure region and roles\"",
                "Install-BoxstarterPackage -PackageName https://raw.githubusercontent.com/aaronparker/build-azure/master/rds-packer/Rds-RegionalRoles.ps1",
                "Write-Host \"---- Customise Windows\"",
                "Install-BoxstarterPackage -PackageName https://raw.githubusercontent.com/aaronparker/build-azure/master/rds-packer/Rds-Customise.ps1"
            ]
        },
        {
            "type": "windows-restart"
        },
        {
            "type": "windows-update",
            "search_criteria": "IsInstalled=0",
            "filters": [
                "exclude:$_.Title -like '*Silverlight*'",
                "include:$true"
            ],
            "update_limit": 25
        },
        {
            "type": "windows-restart"
        },
        {
            "type": "powershell",
            "inline": [
                "Import-Module Boxstarter.Chocolatey",
                "Write-Host \"---- Configure core applications\"",
                "Install-BoxstarterPackage -PackageName https://raw.githubusercontent.com/aaronparker/build-azure/master/rds-packer/Rds-CoreApps.ps1"
            ]
        },
        {
            "type": "windows-restart"
        },
        {
            "type": "windows-update",
            "search_criteria": "IsInstalled=0",
            "filters": [
                "exclude:$_.Title -like '*Silverlight*'",
                "include:$true"
            ],
            "update_limit": 25
        },
        {
            "type": "windows-restart"
        },
        {
            "type": "powershell",
            "inline": [
                "Import-Module Boxstarter.Chocolatey",
                "Set-ExecutionPolicy Bypass -Scope Process -Force",
                "[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12",
                "Write-Host \"---- Seal image\"",
                "Install-BoxstarterPackage -PackageName https://raw.githubusercontent.com/aaronparker/build-azure/master/rds-packer/Seal-Image.ps1",
                "Write-Host \"---- Uninstall Boxstarter & Chocolatey\"",
                "choco uninstall boxstarter -y",
                "Invoke-Expression ((New-Object System.Net.WebClient).DownloadString('https://raw.githubusercontent.com/aaronparker/build-azure/master/rds-packer/Uninstall-Chocolatey.ps1'))",
                "Write-Host \"---- Output software\"",
                "Invoke-WebRequest -Uri \"https://raw.githubusercontent.com/aaronparker/build-azure/master/rds-packer/Get-InstalledSoftware.ps1\" -OutFile \"C:\\Apps\\Get-InstalledSoftware.ps1\" -UseBasicParsing",
                "& C:\\Apps\\Get-InstalledSoftware.ps1",
                "Write-Host \"---- Enable Windows Defender real time scan\"",
                "Set-MpPreference -DisableRealtimeMonitoring $false",
                "Write-Host \"---- Sysprep\"",
                "& $env:SystemRoot\\System32\\Sysprep\\Sysprep.exe /oobe /generalize /quiet /quit",
                "while($true) { $imageState = Get-ItemProperty HKLM:\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Setup\\State | Select ImageState; if($imageState.ImageState -ne 'IMAGE_STATE_GENERALIZE_RESEAL_TO_OOBE') { Write-Output $imageState.ImageState; Start-Sleep -s 10  } else { break } }"
            ]
        }
    ],
    "post-processors": [
        {
            "type": "manifest",
            "output": "packer-win2019-rds-manifest.json",
            "strip_path": true
        }
    ]
}